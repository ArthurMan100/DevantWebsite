<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Checkout</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <style>
        .fixed-width {
            width: 70px;
        }
        .cart-section {
            margin: 0 auto;
            width: 33.33%;
            padding: 20px;
            background: linear-gradient(90deg, #0a0a0a, #1a1a1a);
            border-radius: 10px;
        }
        .gradient-background {
            background: linear-gradient(90deg, #0a0a0a, #1a1a1a);
        }
        .product-info {
            text-align: center;
            margin-top: 10px;
        }
    </style>
    <script src="https://www.paypal.com/sdk/js?client-id=AaNX2rgoobFu-XwrA6vq0fNfOE5Zd4rDRdct70DEyz8MLL_I7KdCoO24CgbQwmzleqcaE2NGkurTCqY6&currency=USD"></script>
</head>
<body class="bg-body-tertiary">
{% include "header.html" %}

<div class="container-fluid">
  <main>


    <h3 class="display-4" style="text-align: center; margin-bottom: 2rem; margin-top:40px;">Select Product and Quantity</h3>
    <br>
    <br>
    <br>
    <div class="container-fluid">
      <div class="row">
        <div class="col-md-6">
          <div class="d-flex align-items-center mb-4 justify-content-center">
            <label class="form-check-label me-2 fs-5" for="quantity-ginger-black-s">Ginger Black T Shirt - Small</label>
            <select class="form-select form-select-sm fixed-width product-quantity fs-5" id="quantity-ginger-black-s" data-price="29.99" aria-label="Quantity for Ginger Black T Shirt - Small">
              <option value="0">0</option>
              <option value="1">1</option>
              <option value="2">2</option>
              <option value="3">3</option>
              <option value="4">4</option>
              <option value="5">5</option>
            </select>
          </div>
          <div class="d-flex align-items-center mb-4 justify-content-center">
            <label class="form-check-label me-2 fs-5" for="quantity-ginger-black-m">Ginger Black T Shirt - Medium</label>
            <select class="form-select form-select-sm fixed-width product-quantity fs-5" id="quantity-ginger-black-m" data-price="29.99" aria-label="Quantity for Ginger Black T Shirt - Medium">
              <option value="0">0</option>
              <option value="1">1</option>
              <option value="2">2</option>
              <option value="3">3</option>
              <option value="4">4</option>
              <option value="5">5</option>
            </select>
          </div>
          <div class="d-flex align-items-center mb-4 justify-content-center">
            <label class="form-check-label me-2 fs-5" for="quantity-ginger-black-l">Ginger Black T Shirt - Large</label>
            <select class="form-select form-select-sm fixed-width product-quantity fs-5" id="quantity-ginger-black-l" data-price="29.99" aria-label="Quantity for Ginger Black T Shirt - Large">
              <option value="0">0</option>
              <option value="1">1</option>
              <option value="2">2</option>
              <option value="3">3</option>
              <option value="4">4</option>
              <option value="5">5</option>
            </select>
          </div>
          <div class="d-flex align-items-center mb-4 justify-content-center">
            <label class="form-check-label me-2 fs-5" for="quantity-ginger-black-xl">Ginger Black T Shirt - XL</label>
            <select class="form-select form-select-sm fixed-width product-quantity fs-5" id="quantity-ginger-black-xl" data-price="29.99" aria-label="Quantity for Ginger Black T Shirt - XL">
              <option value="0">0</option>
              <option value="1">1</option>
              <option value="2">2</option>
              <option value="3">3</option>
              <option value="4">4</option>
              <option value="5">5</option>
            </select>
          </div>

          <!-- Separation between Ginger and Love Life T-shirts -->
          <hr class="my-4">

          <div class="d-flex align-items-center mb-4 justify-content-center">
            <label class="form-check-label me-2 fs-5" for="quantity-love-life-white-s">Love Life Misc. White T Shirt - Small</label>
            <select class="form-select form-select-sm fixed-width product-quantity fs-5" id="quantity-love-life-white-s" data-price="29.99" aria-label="Quantity for Love Life Misc. White T Shirt - Small">
              <option value="0">0</option>
              <option value="1">1</option>
              <option value="2">2</option>
              <option value="3">3</option>
              <option value="4">4</option>
              <option value="5">5</option>
            </select>
          </div>
          <div class="d-flex align-items-center mb-4 justify-content-center">
            <label class="form-check-label me-2 fs-5" for="quantity-love-life-white-m">Love Life Misc. White T Shirt - Medium</label>
            <select class="form-select form-select-sm fixed-width product-quantity fs-5" id="quantity-love-life-white-m" data-price="29.99" aria-label="Quantity for Love Life Misc. White T Shirt - Medium">
              <option value="0">0</option>
              <option value="1">1</option>
              <option value="2">2</option>
              <option value="3">3</option>
              <option value="4">4</option>
              <option value="5">5</option>
            </select>
          </div>
          <div class="d-flex align-items-center mb-4 justify-content-center">
            <label class="form-check-label me-2 fs-5" for="quantity-love-life-white-l">Love Life Misc. White T Shirt - Large</label>
            <select class="form-select form-select-sm fixed-width product-quantity fs-5" id="quantity-love-life-white-l" data-price="29.99" aria-label="Quantity for Love Life Misc. White T Shirt - Large">
              <option value="0">0</option>
              <option value="1">1</option>
              <option value="2">2</option>
              <option value="3">3</option>
              <option value="4">4</option>
              <option value="5">5</option>
            </select>
          </div>
          <div class="d-flex align-items-center mb-4 justify-content-center">
            <label class="form-check-label me-2 fs-5" for="quantity-love-life-white-xl">Love Life Misc. White T Shirt - XL</label>
            <select class="form-select form-select-sm fixed-width product-quantity fs-5" id="quantity-love-life-white-xl" data-price="29.99" aria-label="Quantity for Love Life Misc. White T Shirt - XL">
              <option value="0">0</option>
              <option value="1">1</option>
              <option value="2">2</option>
              <option value="3">3</option>
              <option value="4">4</option>
              <option value="5">5</option>
            </select>
          </div>
        </div>
        <div class="col-md-6">
          <div class="row">
            <div class="col-md-6 mb-4">
              <img src="https://raw.githubusercontent.com/ArthurMan100/DevantWebsite/main/static/assets/img/tshirt_1.png" class="img-fluid" alt="Ginger Black T Shirt">
              <div class="product-info">
                <p class="fw-bold">Ginger Black T Shirt</p>
                <p>Price: £24.99</p>
                <p><strong>Sizes:</strong> <br> Small <br> Medium <br> Large <br> X-Large</p>
              </div>
            </div>
            <div class="col-md-6 mb-4">
              <img src="https://raw.githubusercontent.com/ArthurMan100/DevantWebsite/main/static/assets/img/tshirt_2.png" class="img-fluid" alt="Love Life Misc. White T Shirt">
              <div class="product-info">
                <p class="fw-bold">Love Life Misc. White T Shirt</p>
                <p>Price: £24.99</p>
                <p><strong>Sizes: </strong> <br> Small <br> Medium <br> Large <br> X-Large</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <hr class="my-4">
    <br>

    <div class="row g-5">
      <div class="col-md-12">
        <div class="cart-section">
          <h4 class="d-flex justify-content-between align-items-center mb-3 fs-4">
            <span class="text-primary">Your cart</span>
            <span class="badge bg-primary rounded-pill" id="cart-count">0</span>
          </h4>
          <ul class="list-group mb-3" id="cart-items">
            <!-- Cart items will be dynamically inserted here -->
          </ul>
          <li class="list-group-item d-flex justify-content-between">
            <span>Total (USD)</span>
            <strong id="cart-total">$0.00</strong>
          </li>
          <div id="paypal-button-container"></div>
        </div>
      </div>
    </div>
  </main>

  {% include "footer.html" %}
</div>


<script>
document.addEventListener('DOMContentLoaded', function() {
  const quantities = document.querySelectorAll('.product-quantity');
  const cartItems = document.getElementById('cart-items');
  const cartCount = document.getElementById('cart-count');
  const cartTotal = document.getElementById('cart-total');

  quantities.forEach(quantity => {
    quantity.addEventListener('change', updateCart);
  });

  function updateCart() {
    cartItems.innerHTML = '';
    let totalCount = 0;
    let totalPrice = 0.0;

    quantities.forEach(quantity => {
      const qty = quantity.value;
      if (qty > 0) {
        const price = quantity.getAttribute('data-price');
        const itemTotal = qty * price;
        totalCount += parseInt(qty);
        totalPrice += itemTotal;

        const item = document.createElement('li');
        item.classList.add('list-group-item', 'd-flex', 'justify-content-between', 'lh-sm');
        const itemName = quantity.previousElementSibling.innerText;

        // Image paths with correct GitHub URLs
        let productImage = '';
        if (itemName.includes('Ginger Black T Shirt')) {
          productImage = 'https://raw.githubusercontent.com/ArthurMan100/DevantWebsite/main/static/assets/img/tshirt_1.png'; // T-shirt 1
        } else if (itemName.includes('Love Life Misc. White T Shirt')) {
          productImage = 'https://raw.githubusercontent.com/ArthurMan100/DevantWebsite/main/static/assets/img/tshirt_2.png'; // T-shirt 2
        }

        item.innerHTML = `
          <div class="d-flex">
            <img src="${productImage}" alt="${itemName}" class="cart-item-image" style="width: 50px; height: 50px; margin-right: 10px;">
            <div>
              <h6 class="my-0">${itemName}</h6>
              <small class="text-body-secondary">Quantity: ${qty}</small>
            </div>
          </div>
          <span class="text-body-secondary">$${itemTotal.toFixed(2)}</span>
        `;
        cartItems.appendChild(item);
      }
    });

    cartCount.innerText = totalCount;
    cartTotal.innerText = `$${totalPrice.toFixed(2)}`;
  }

paypal.Buttons({
  createOrder: function(data, actions) {
    const items = getSelectedItems();
    const totalAmount = items.reduce((sum, item) => sum + item.price * item.quantity, 0).toFixed(2);

    return actions.order.create({
      purchase_units: [{
        amount: {
          currency_code: "USD", // Change back to USD
          value: totalAmount,
          breakdown: {
            item_total: {
              currency_code: "USD", // Change back to USD
              value: totalAmount
            }
          }
        },
        items: items.map(item => ({
          name: item.name,
          unit_amount: {
            currency_code: 'USD', // Change back to USD
            value: item.price
          },
          quantity: item.quantity,
          image_url: item.image_url
        }))
      }]
    });
  },
  onApprove: function(data, actions) {
    return actions.order.capture().then(function(details) {
      // Send the data to the Flask backend
      const buyerInfo = {
        name: details.payer.name.given_name + " " + details.payer.name.surname,
        email: details.payer.email_address,
        address: details.purchase_units[0].shipping.address.address_line_1,
        city: details.purchase_units[0].shipping.address.admin_area_2,
        postcode: details.purchase_units[0].shipping.address.postal_code,
        items: getSelectedItems()
      };

      // Send the buyer information to the Flask server
      fetch('/save-order', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(buyerInfo)
      })
      .then(response => response.json())
      .then(data => {
        if (data.status === 'success') {
          window.location.href = "/thanks";
        } else {
          alert("There was an issue saving your order. Please contact support.");
        }
      });
    });
  }
}).render('#paypal-button-container');


  function getSelectedItems() {
    const selectedItems = [];
    quantities.forEach(quantity => {
      const qty = quantity.value;
      if (qty > 0) {
        const itemName = quantity.previousElementSibling.innerText;
        let productImage = '';

        // Image paths with correct GitHub URLs
        if (itemName.includes('Ginger Black T Shirt')) {
          productImage = 'https://raw.githubusercontent.com/ArthurMan100/DevantWebsite/main/static/assets/img/tshirt_1.png'; // T-shirt 1
        } else if (itemName.includes('Love Life Misc. White T Shirt')) {
          productImage = 'https://raw.githubusercontent.com/ArthurMan100/DevantWebsite/main/static/assets/img/tshirt_2.png'; // T-shirt 2
        }

        selectedItems.push({
          name: itemName,
          quantity: qty,
          price: parseFloat(quantity.getAttribute('data-price')),
          image_url: productImage  // Use the updated image URLs
        });
      }
    });
    return selectedItems;
  }
});


</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
</body>
</html>
